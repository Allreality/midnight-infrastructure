<!--
FILE: midnight-x402-fixed.html
LOCATION: C:\projects\midnight-infrastructure\midnight-x402-fixed.html
PURPOSE: Midnight Compliance Intelligence - Main payment interface with Phantom wallet integration
REQUIRES: 
  - payment_api.py running on http://localhost:5008
  - Web server running on http://localhost:8000
  - Phantom wallet extension installed in Chrome
ACCESS: http://localhost:8000/midnight-x402-fixed.html
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midnight Compliance Intelligence - AI-Powered Blockchain Compliance</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // API Configuration
        const API_BASE_URL = 'http://localhost:5008/api';
        
        const MidnightCompliance = () => {
            const [wallet, setWallet] = useState(null);
            const [walletConnected, setWalletConnected] = useState(false);
            const [connecting, setConnecting] = useState(false);
            const [selectedService, setSelectedService] = useState(null);
            const [paymentInProgress, setPaymentInProgress] = useState(false);
            const [serviceResult, setServiceResult] = useState(null);
            const [phantomInstalled, setPhantomInstalled] = useState(false);
            const [stats, setStats] = useState({
                documents: 169,
                categories: 27,
                agents: 6
            });

            // Check if Phantom is installed on component mount
            useEffect(() => {
                const checkPhantom = () => {
                    // Phantom injects at window.phantom.solana
                    const isPhantomInstalled = window.phantom?.solana?.isPhantom;
                    setPhantomInstalled(isPhantomInstalled);
                    console.log('Checking for Phantom...');
                    console.log('window.phantom:', window.phantom);
                    console.log('window.phantom?.solana:', window.phantom?.solana);
                    console.log('Phantom installed:', isPhantomInstalled);
                };
                
                // Check immediately
                checkPhantom();
                
                // Also check after a delay (Phantom might inject itself after page load)
                setTimeout(checkPhantom, 1000);
                setTimeout(checkPhantom, 2000);
            }, []);

            // Get Phantom provider
            const getProvider = () => {
                // Modern Phantom injects at window.phantom.solana
                if (window.phantom?.solana?.isPhantom) {
                    console.log('Phantom provider found at window.phantom.solana!');
                    return window.phantom.solana;
                }
                // Fallback to old location
                if (window.solana?.isPhantom) {
                    console.log('Phantom provider found at window.solana!');
                    return window.solana;
                }
                console.log('Phantom not found anywhere');
                console.log('Available on window:', Object.keys(window).filter(k => k.includes('phantom') || k.includes('solana')));
                return null;
            };

            // Connect wallet
            const connectWallet = async () => {
                const provider = getProvider();
                
                if (!provider) {
                    alert('Phantom wallet is not installed!\n\nPlease install Phantom wallet extension first.');
                    window.open('https://phantom.app/', '_blank');
                    return;
                }

                setConnecting(true);
                try {
                    const resp = await provider.connect();
                    const publicKey = resp.publicKey.toString();
                    setWallet(publicKey);
                    setWalletConnected(true);
                    console.log('Connected to wallet:', publicKey);
                } catch (err) {
                    console.error('Connection error:', err);
                    alert('Failed to connect wallet: ' + err.message);
                } finally {
                    setConnecting(false);
                }
            };

            // Disconnect wallet
            const disconnectWallet = async () => {
                try {
                    const provider = getProvider();
                    if (provider) {
                        await provider.disconnect();
                    }
                    setWallet(null);
                    setWalletConnected(false);
                    console.log('Wallet disconnected');
                } catch (err) {
                    console.error('Disconnect error:', err);
                }
            };

            // Purchase service
            const purchaseService = async (service) => {
                if (!walletConnected) {
                    alert('Please connect your wallet first!');
                    return;
                }

                setPaymentInProgress(true);
                setSelectedService(service);

                try {
                    console.log('Starting purchase for service:', service.id);
                    
                    // 1. Create payment request
                    const paymentReq = await fetch(`${API_BASE_URL}/create-payment-request`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            service_id: service.id,
                            customer_wallet: wallet,
                            parameters: service.parameters || {}
                        })
                    });

                    const paymentData = await paymentReq.json();
                    console.log('Payment request created:', paymentData);

                    // 2. Send SOL transaction
                    const provider = getProvider();
                    const connection = new solanaWeb3.Connection(
                        solanaWeb3.clusterApiUrl('devnet'),
                        'confirmed'
                    );

                    const transaction = new solanaWeb3.Transaction().add(
                        solanaWeb3.SystemProgram.transfer({
                            fromPubkey: new solanaWeb3.PublicKey(wallet),
                            toPubkey: new solanaWeb3.PublicKey(paymentData.receiver_wallet),
                            lamports: paymentData.amount_lamports
                        })
                    );

                    transaction.feePayer = new solanaWeb3.PublicKey(wallet);
                    const { blockhash } = await connection.getLatestBlockhash();
                    transaction.recentBlockhash = blockhash;

                    console.log('Requesting signature from wallet...');
                    const signed = await provider.signTransaction(transaction);
                    
                    console.log('Sending transaction...');
                    const signature = await connection.sendRawTransaction(signed.serialize());
                    
                    console.log('Confirming transaction...');
                    await connection.confirmTransaction(signature);

                    console.log('Transaction confirmed:', signature);

                    // 3. Verify payment
                    const verifyResp = await fetch(`${API_BASE_URL}/verify-payment/${paymentData.payment_id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            transaction_signature: signature
                        })
                    });

                    const verifyData = await verifyResp.json();
                    console.log('Payment verified:', verifyData);

                    // 4. Execute service
                    const executeResp = await fetch(`${API_BASE_URL}/execute-service/${paymentData.payment_id}`, {
                        method: 'POST'
                    });

                    const result = await executeResp.json();
                    console.log('Service result:', result);

                    setServiceResult(result);
                    alert(`‚úÖ Service purchased successfully!\n\nTransaction: ${signature.substring(0, 20)}...`);

                } catch (error) {
                    console.error('Purchase error:', error);
                    alert(`‚ùå Error: ${error.message}`);
                } finally {
                    setPaymentInProgress(false);
                }
            };

            // Services data
            const services = [
                {
                    id: 'knowledge_search',
                    name: "Knowledge Base Search",
                    icon: "üîç",
                    color: "bg-blue-500",
                    price: "0.01 SOL",
                    usdPrice: "$1.37",
                    description: "Query 169+ compliance documents instantly",
                    features: [
                        "Full-text search across NIST 800-171",
                        "Context-aware results",
                        "Instant response time",
                        "Source attribution"
                    ],
                    savings: "vs $50-100 consultant call"
                },
                {
                    id: 'gap_analysis_quick',
                    name: "Gap Analysis",
                    icon: "üìä",
                    color: "bg-purple-500",
                    price: "0.037 SOL",
                    usdPrice: "$5",
                    description: "Quick compliance gap assessment",
                    features: [
                        "Single NIST control family analysis",
                        "Actionable recommendations",
                        "Midnight blockchain integration guide",
                        "AMD SEV-SNP hardware enforcement"
                    ],
                    savings: "vs $500-1,500 traditional audit"
                },
                {
                    id: 'full_documentation',
                    name: "Full Documentation",
                    icon: "üìù",
                    color: "bg-green-500",
                    price: "0.15 SOL",
                    usdPrice: "$20",
                    description: "Complete compliance framework documentation",
                    features: [
                        "All 14 NIST 800-171 families",
                        "Implementation roadmap",
                        "Blockchain-based verification",
                        "Hardware-enforced security guides"
                    ],
                    savings: "vs $2,000-5,000 consultant documentation"
                },
                {
                    id: 'system_audit',
                    name: "System Audit",
                    icon: "üîê",
                    color: "bg-red-500",
                    price: "0.73 SOL",
                    usdPrice: "$100",
                    description: "DISA-STIG/CIS compliance audit + remediation",
                    features: [
                        "Automated security scanning",
                        "300+ compliance checks",
                        "Detailed remediation report",
                        "Ubuntu Security Guide integration"
                    ],
                    savings: "vs $500-1,500 per system audit"
                },
                {
                    id: 'comprehensive_analysis',
                    name: "Comprehensive Analysis",
                    icon: "üéØ",
                    color: "bg-orange-500",
                    price: "0.37 SOL",
                    usdPrice: "$50",
                    description: "Full framework assessment with roadmap",
                    features: [
                        "Complete gap analysis",
                        "Implementation timeline",
                        "Cost-benefit analysis",
                        "Integration strategy"
                    ],
                    savings: "vs $5,000-15,000 full consulting engagement"
                }
            ];

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
                    {/* Hero Section */}
                    <div className="p-8 text-center border-b border-white/10">
                        <h1 className="text-5xl font-bold text-white mb-4">
                            üåô Midnight Compliance Intelligence
                        </h1>
                        <p className="text-purple-200 text-xl mb-2">
                            AI-Powered Blockchain Compliance at 1% of Traditional Costs
                        </p>
                        <p className="text-purple-300 text-sm mb-6">
                            NIST 800-171 ‚Ä¢ HIPAA ‚Ä¢ FedRAMP ‚Ä¢ CMMC ‚Ä¢ DISA-STIG ‚Ä¢ CIS Benchmarks
                        </p>
                        
                        <div className="flex flex-wrap justify-center gap-4 mb-6">
                            <div className="bg-blue-500/20 border border-blue-500/30 px-4 py-2 rounded-lg">
                                <span className="text-blue-300">‚ö° {stats.agents} Agents Operational</span>
                            </div>
                            <div className="bg-green-500/20 border border-green-500/30 px-4 py-2 rounded-lg">
                                <span className="text-green-300">üìö {stats.documents} Documents</span>
                            </div>
                            <div className="bg-purple-500/20 border border-purple-500/30 px-4 py-2 rounded-lg">
                                <span className="text-purple-300">üóÇÔ∏è {stats.categories} Categories</span>
                            </div>
                            <div className="bg-orange-500/20 border border-orange-500/30 px-4 py-2 rounded-lg">
                                <span className="text-orange-300">‚õìÔ∏è Midnight Blockchain</span>
                            </div>
                        </div>

                        {/* Wallet Status Indicator */}
                        {!phantomInstalled && (
                            <div className="bg-red-500/20 border border-red-500/30 rounded-lg p-3 mb-4 max-w-2xl mx-auto">
                                <span className="text-red-300">
                                    ‚ö†Ô∏è Phantom Wallet not detected. Please install the browser extension.
                                </span>
                            </div>
                        )}

                        {/* Wallet Connection */}
                        <div className="flex justify-center gap-4 mb-4">
                            {!walletConnected ? (
                                <button 
                                    onClick={connectWallet}
                                    disabled={connecting || !phantomInstalled}
                                    className="bg-purple-500 hover:bg-purple-600 disabled:bg-gray-500 text-white px-8 py-3 rounded-lg font-semibold transition-all transform hover:scale-105 flex items-center gap-2"
                                >
                                    {connecting ? (
                                        <>
                                            <span className="animate-spin">‚è≥</span>
                                            Connecting...
                                        </>
                                    ) : !phantomInstalled ? (
                                        <>
                                            <span>üëª</span>
                                            Install Phantom Wallet
                                        </>
                                    ) : (
                                        <>
                                            <span>üëª</span>
                                            Connect Phantom Wallet
                                        </>
                                    )}
                                </button>
                            ) : (
                                <div className="flex items-center gap-4">
                                    <div className="bg-green-500/20 border border-green-500/30 px-6 py-3 rounded-lg">
                                        <span className="text-green-300 font-semibold">
                                            ‚úÖ {wallet.substring(0, 4)}...{wallet.substring(wallet.length - 4)}
                                        </span>
                                    </div>
                                    <button 
                                        onClick={disconnectWallet}
                                        className="bg-red-500/20 border border-red-500/30 hover:bg-red-500/30 text-red-300 px-6 py-3 rounded-lg font-semibold transition-all"
                                    >
                                        Disconnect
                                    </button>
                                </div>
                            )}
                        </div>

                        {!walletConnected && phantomInstalled && (
                            <div className="text-sm text-purple-300 max-w-md mx-auto">
                                <p className="mb-2">Phantom wallet detected! Click the button above to connect.</p>
                            </div>
                        )}

                        {!phantomInstalled && (
                            <div className="text-sm text-purple-300 max-w-md mx-auto">
                                <p className="mb-2">Don't have Phantom wallet?</p>
                                <a 
                                    href="https://phantom.app/" 
                                    target="_blank"
                                    className="text-purple-400 hover:text-purple-200 underline"
                                >
                                    Install Phantom Wallet Extension ‚Üí
                                </a>
                            </div>
                        )}

                        <div className="mt-4 text-sm text-purple-300">
                            <span className="bg-black/30 px-3 py-1 rounded">
                                Powered by X402 Protocol ‚Ä¢ Solana Devnet ‚Ä¢ Pay with SOL
                            </span>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto p-8">
                        {/* Services Marketplace */}
                        <div className="mb-16">
                            <h2 className="text-3xl font-bold text-white mb-8 text-center">
                                AI Agent Services - Pay with SOL
                            </h2>
                            
                            {!walletConnected && (
                                <div className="bg-yellow-500/20 border border-yellow-500/30 rounded-lg p-4 mb-6 text-center">
                                    <span className="text-yellow-300">
                                        ‚ö†Ô∏è Connect your wallet to purchase services
                                    </span>
                                </div>
                            )}

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {services.map((service, idx) => (
                                    <div 
                                        key={idx}
                                        className="bg-white/10 backdrop-blur rounded-lg p-6 border border-white/20 hover:border-purple-400 transition-all"
                                    >
                                        <div className="flex items-center justify-between mb-4">
                                            <div className={`${service.color} p-3 rounded-lg text-3xl`}>
                                                {service.icon}
                                            </div>
                                            <div className="text-right">
                                                <div className="text-2xl font-bold text-white">{service.price}</div>
                                                <div className="text-sm text-purple-300">{service.usdPrice}</div>
                                            </div>
                                        </div>
                                        <h3 className="text-xl font-bold text-white mb-2">{service.name}</h3>
                                        <p className="text-purple-200 text-sm mb-4">{service.description}</p>
                                        <div className="space-y-2 mb-4">
                                            {service.features.map((feature, fIdx) => (
                                                <div key={fIdx} className="flex items-start gap-2">
                                                    <div className="w-1.5 h-1.5 bg-purple-400 rounded-full mt-2"></div>
                                                    <span className="text-xs text-purple-100">{feature}</span>
                                                </div>
                                            ))}
                                        </div>
                                        <div className="bg-green-500/20 border border-green-500/30 rounded px-3 py-1 text-center mb-4">
                                            <span className="text-green-300 text-xs font-semibold">{service.savings}</span>
                                        </div>
                                        <button 
                                            onClick={() => purchaseService(service)}
                                            disabled={!walletConnected || paymentInProgress}
                                            className="w-full bg-purple-500 hover:bg-purple-600 disabled:bg-gray-500 disabled:cursor-not-allowed text-white py-2 rounded transition-colors font-semibold"
                                        >
                                            {paymentInProgress && selectedService?.id === service.id ? (
                                                <span className="flex items-center justify-center gap-2">
                                                    <span className="animate-spin">‚è≥</span>
                                                    Processing...
                                                </span>
                                            ) : (
                                                'Purchase with SOL'
                                            )}
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Service Result Display */}
                        {serviceResult && (
                            <div className="mb-16">
                                <div className="bg-green-500/20 border border-green-500/30 rounded-lg p-6">
                                    <h3 className="text-2xl font-bold text-white mb-4">
                                        ‚úÖ Service Completed Successfully!
                                    </h3>
                                    <div className="bg-black/30 rounded p-4 overflow-auto">
                                        <pre className="text-green-300 text-sm">
                                            {JSON.stringify(serviceResult, null, 2)}
                                        </pre>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* How It Works */}
                        <div className="mb-16">
                            <h2 className="text-3xl font-bold text-white mb-8 text-center">
                                How X402 Payment Works
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div className="bg-white/10 backdrop-blur rounded-lg p-6 border border-white/20 text-center">
                                    <div className="text-4xl mb-3">üëª</div>
                                    <h3 className="text-white font-bold mb-2">1. Connect Wallet</h3>
                                    <p className="text-purple-200 text-sm">Connect your Phantom wallet to get started</p>
                                </div>
                                <div className="bg-white/10 backdrop-blur rounded-lg p-6 border border-white/20 text-center">
                                    <div className="text-4xl mb-3">üõí</div>
                                    <h3 className="text-white font-bold mb-2">2. Select Service</h3>
                                    <p className="text-purple-200 text-sm">Choose an AI agent service</p>
                                </div>
                                <div className="bg-white/10 backdrop-blur rounded-lg p-6 border border-white/20 text-center">
                                    <div className="text-4xl mb-3">üí≥</div>